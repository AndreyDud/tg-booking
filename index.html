<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Запись на встречу</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Запись на встречу</h1>

  <form id="bookingForm">
    <label>Дата:
      <select id="dateSelect" required></select>
    </label>
    <label>Время:
      <select id="timeSelect" required></select>
    </label>
    <label>Имя и Фамилия:
      <input type="text" id="nameInput" required />
    </label>
    <label>Telegram Username:
      <input type="text" id="tgInput" required />
    </label>
    <button type="submit">Записаться</button>
  </form>

  <script>
    const dateSelect = document.getElementById("dateSelect");
    const timeSelect = document.getElementById("timeSelect");

    const API_URL = "https://script.google.com/macros/s/AKfycbzUcmuM-5L3eu6a9m-qITRN2dG2KF-xt8-bd8TnUBV6Kd3dFdxZeKbr2beav_GTsOdcjA/exec";

    let availableSlots = {};

    async function loadSlots() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();

        availableSlots = {};
        data.forEach(slot => {
          if (!availableSlots[slot.date]) availableSlots[slot.date] = [];
          availableSlots[slot.date].push(slot.time);
        });

        dateSelect.innerHTML = "";
        Object.keys(availableSlots).forEach(date => {
          const opt = document.createElement("option");
          opt.value = date;
          opt.textContent = new Date(date).toLocaleDateString("ru-RU");
          dateSelect.appendChild(opt);
        });

        dateSelect.value = Object.keys(availableSlots)[0];
        updateTimes();
      } catch (err) {
        alert("Ошибка загрузки доступных слотов.");
        console.error(err);
      }
    }

    function updateTimes() {
      const selectedDate = dateSelect.value;
      timeSelect.innerHTML = "";
      (availableSlots[selectedDate] || []).forEach(time => {
        const opt = document.createElement("option");
        opt.value = time;
        opt.textContent = time;
        timeSelect.appendChild(opt);
      });
    }

    dateSelect.addEventListener("change", updateTimes);

    document.getElementById("bookingForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        date: dateSelect.value,
        time: timeSelect.value,
        name: document.getElementById("nameInput").value,
        username: document.getElementById("tgInput").value,
        telegramId: "web"
      };

      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data),
        headers: {
          "Content-Type": "application/json"
        }
      });

      const text = await res.text();
      if (text === "ok") {
        alert("Вы успешно записались!");
        loadSlots();
      } else if (text === "slot_taken") {
        alert("Этот слот уже занят, выберите другой.");
        loadSlots();
      } else {
        alert("Ошибка при записи.");
      }
    });

    loadSlots();
  </script>
</body>
</html>
